___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.

___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "Evidon -  Universal Consent Platform",
  "brand": {
    "id": "github.com_EvidonCMP",
    "displayName": "EvidonCMP",
    "thumbnail": "data:image/png;base64,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\u003d\u003d"
  },
  "description": "Universal Consent Platform is a CMP provided by Crownpeak. Data is collected for personalization and analytic purposes. For more information please visit: https://business.safety.google/privacy.",
  "containerContexts": [
    "WEB"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "TEXT",
    "name": "companyId",
    "displayName": "CompanyID",
    "simpleValueType": true,
    "valueValidators": [
      {
        "type": "POSITIVE_NUMBER",
        "errorMessage": "The Company Id must be a positive integer."
      },
      {
        "type": "NON_EMPTY",
        "errorMessage": "The Company Id cannot be undefined."
      }
    ],
    "valueHint": "Company ID (Required)"
  },
  {
    "type": "CHECKBOX",
    "name": "enableUrlPassthrough",
    "checkboxText": "Enables URL passthrough",
    "simpleValueType": true
  },
  {
    "type": "CHECKBOX",
    "name": "enableDebugMode",
    "checkboxText": "Enabled Debug Mode",
    "simpleValueType": true,
    "help": "Debug mode will log the user\u0027s consent state to browser\u0027s console."
  },
  {
    "type": "CHECKBOX",
    "name": "advancedMode",
    "checkboxText": "Enable Advanced Mode",
    "simpleValueType": true,
    "defaultValue": true
  },
  {
    "type": "CHECKBOX",
    "name": "nonProductionNotice",
    "checkboxText": "Non Production Notice",
    "simpleValueType": true,
    "defaultValue": false
  },
  {
    "type": "SELECT",
    "name": "activeTranslationsLangCode",
    "displayName": "Override Language Code",
    "macrosInSelect": false,
    "selectItems": [
      {
        "value": "ar",
        "displayValue": "Arabic (ar)"
      },
      {
        "value": "hy",
        "displayValue": "Armenian (hy)"
      },
      {
        "value": "de-at",
        "displayValue": "Austrian German (de-at)"
      },
      {
        "value": "az",
        "displayValue": "Azerbaijani (az)"
      },
      {
        "value": "bn",
        "displayValue": "Bengali (bn)"
      },
      {
        "value": "bs",
        "displayValue": "Bosnian (bs)"
      },
      {
        "value": "bg",
        "displayValue": "Bulgarian (bg)"
      },
      {
        "value": "en-ca",
        "displayValue": "Canadian English (en-ca)"
      },
      {
        "value": "fr-ca",
        "displayValue": "Canadian French (fr-ca)"
      },
      {
        "value": "ca",
        "displayValue": "Catalan (ca)"
      },
      {
        "value": "hr",
        "displayValue": "Croatian (hr)"
      },
      {
        "value": "cs",
        "displayValue": "Czech (cs)"
      },
      {
        "value": "da",
        "displayValue": "Danish (da)"
      },
      {
        "value": "nl",
        "displayValue": "Dutch (nl)"
      },
      {
        "value": "ar-eg",
        "displayValue": "Egyptian Arabic (ar-eg)"
      },
      {
        "value": "en-gb",
        "displayValue": "English (en-gb)"
      },
      {
        "value": "en-us",
        "displayValue": "English (en-us)"
      },
      {
        "value": "et",
        "displayValue": "Estonian (et)"
      },
      {
        "value": "fi",
        "displayValue": "Finnish (fi)"
      },
      {
        "value": "nl-be",
        "displayValue": "Flemish (nl-be)"
      },
      {
        "value": "fr",
        "displayValue": "French (fr)"
      },
      {
        "value": "ka",
        "displayValue": "Georgian (ka)"
      },
      {
        "value": "de",
        "displayValue": "German (de)"
      },
      {
        "value": "el",
        "displayValue": "Greek (el)"
      },
      {
        "value": "he",
        "displayValue": "Hebrew (he)"
      },
      {
        "value": "hi",
        "displayValue": "Hindi (hi)"
      },
      {
        "value": "hu",
        "displayValue": "Hungarian (hu)"
      },
      {
        "value": "is",
        "displayValue": "Icelandic (is)"
      },
      {
        "value": "id",
        "displayValue": "Indonesian (id)"
      },
      {
        "value": "it",
        "displayValue": "Italian (it)"
      },
      {
        "value": "ja",
        "displayValue": "Japanese (ja)"
      },
      {
        "value": "ko",
        "displayValue": "Korean (ko)"
      },
      {
        "value": "lv",
        "displayValue": "Latvian (lv)"
      },
      {
        "value": "lt",
        "displayValue": "Lithuanian (lt)"
      },
      {
        "value": "mk",
        "displayValue": "Macedonian (mk)"
      },
      {
        "value": "ms",
        "displayValue": "Malay (ms)"
      },
      {
        "value": "mt",
        "displayValue": "Maltese (mt)"
      },
      {
        "value": "no",
        "displayValue": "Norwegian (no)"
      },
      {
        "value": "pl",
        "displayValue": "Polish (pl)"
      },
      {
        "value": "pt",
        "displayValue": "Portuguese (pt)"
      },
      {
        "value": "pt-br",
        "displayValue": "Portuguese Brazil (pt-br)"
      },
      {
        "value": "ro",
        "displayValue": "Romanian (ro)"
      },
      {
        "value": "ru",
        "displayValue": "Russian (ru)"
      },
      {
        "value": "sr",
        "displayValue": "Serbian (sr)"
      },
      {
        "value": "zh-cn",
        "displayValue": "Simplified Chinese (zh-cn)"
      },
      {
        "value": "sk",
        "displayValue": "Slovak (sk)"
      },
      {
        "value": "sl",
        "displayValue": "Slovenian (sl)"
      },
      {
        "value": "es",
        "displayValue": "Spanish (es)"
      },
      {
        "value": "es-us",
        "displayValue": "Spanish (es-us)"
      },
      {
        "value": "es-ar",
        "displayValue": "Spanish Argentina (es-ar)"
      },
      {
        "value": "sv",
        "displayValue": "Swedish (sv)"
      },
      {
        "value": "fr-ch",
        "displayValue": "Swiss French (fr-ch)"
      },
      {
        "value": "de-ch",
        "displayValue": "Swiss German (de-ch)"
      },
      {
        "value": "ph",
        "displayValue": "Tagalog (ph)"
      },
      {
        "value": "th",
        "displayValue": "Thai (th)"
      },
      {
        "value": "zh-tw",
        "displayValue": "Traditional Chinese (zh-tw)"
      },
      {
        "value": "tr",
        "displayValue": "Turkish (tr)"
      },
      {
        "value": "uk",
        "displayValue": "Ukranian (uk)"
      },
      {
        "value": "vi",
        "displayValue": "Vietnamese (vi)"
      }
    ],
    "simpleValueType": true,
    "notSetText": "Default Language",
    "help": "This option allows you to override the default language set in the notice or detected by the user\u0027s browser, enabling the notice banner or barrier to be displayed in the selected language."
  },
  {
    "type": "GROUP",
    "name": "defaultConsent",
    "displayName": "Default Consent State",
    "groupStyle": "NO_ZIPPY",
    "subParams": [
      {
        "type": "PARAM_TABLE",
        "name": "regionSettings",
        "displayName": "",
        "paramTableColumns": [
          {
            "param": {
              "type": "TEXT",
              "name": "region",
              "displayName": "Region (leave blank to apply globally)",
              "simpleValueType": true,
              "valueHint": "eg. us-ca, gb, fr"
            },
            "isUnique": true
          },
          {
            "param": {
              "type": "SELECT",
              "name": "adStorage",
              "displayName": "Ad Storage",
              "macrosInSelect": false,
              "selectItems": [
                {
                  "value": "granted",
                  "displayValue": "granted"
                },
                {
                  "value": "denied",
                  "displayValue": "denied"
                }
              ],
              "simpleValueType": true,
              "help": "Allow advertising cookies before user gives consent",
              "defaultValue": "denied"
            },
            "isUnique": false
          },
          {
            "param": {
              "type": "SELECT",
              "name": "analyticsStorage",
              "displayName": "Analytics Storage",
              "macrosInSelect": false,
              "selectItems": [
                {
                  "value": "granted",
                  "displayValue": "granted"
                },
                {
                  "value": "denied",
                  "displayValue": "denied"
                }
              ],
              "simpleValueType": true,
              "defaultValue": "denied",
              "help": "Allow analytics cookies before user gives consent"
            },
            "isUnique": false
          },
          {
            "param": {
              "type": "SELECT",
              "name": "adPersonalization",
              "displayName": "Ad Personalization",
              "macrosInSelect": false,
              "selectItems": [
                {
                  "value": "granted",
                  "displayValue": "granted"
                },
                {
                  "value": "denied",
                  "displayValue": "denied"
                }
              ],
              "simpleValueType": true,
              "defaultValue": "denied",
              "help": "Allow ads personalization before user gives consent"
            },
            "isUnique": false
          },
          {
            "param": {
              "type": "SELECT",
              "name": "adUserData",
              "displayName": "Ad User Data",
              "macrosInSelect": false,
              "selectItems": [
                {
                  "value": "granted",
                  "displayValue": "granted"
                },
                {
                  "value": "denied",
                  "displayValue": "denied"
                }
              ],
              "simpleValueType": true,
              "defaultValue": "denied",
              "help": "Allow sending user data to Google for advertising purposes before user gives consent"
            },
            "isUnique": false
          }
        ]
      }
    ],
    "help": "A default consent state of \u0027denied\u0027 will apply until the user has submitted a consent. You can add different default states for users in different geographical regions. Please use ISO-3166-1 alpha-2 country codes for region values."
  }
]


___SANDBOXED_JS_FOR_WEB_TEMPLATE___

/* --- Imports --- */
const log = require('logToConsole');
const encodeUriComponent = require('encodeUriComponent');
const injectScript = require('injectScript');
const setInWindow = require('setInWindow');
const getUrl = require('getUrl');
const makeInteger = require('makeInteger');
const setDefaultConsentState = require('setDefaultConsentState');
const gtagSet = require('gtagSet');
const updateConsentState = require('updateConsentState');
const copyFromWindow = require("copyFromWindow");
const companyId = data.companyId;
const callLater = require("callLater");
const stagingNotice= data.nonProductionNotice;
const activeTranslationsLangCode  = data.activeTranslationsLangCode ;

/* --- Constants --- */
const urls = {
    production: "https://c.evidon.com",
    staging: "https://staging.betrad.com",
};
const url = [7654, 6914].indexOf(data.companyId) !== -1 ? urls.staging : urls.production;

const debug = url + "/gtm/debug.js";
const evidonCDN = url + "/gtm/evidon-loader.js";


const splitInput = (input) => {
  return input.split(',')
    .map(entry => entry.trim())
    .filter(entry => entry.length !== 0);
};

const onSucessDebug = () => {
  if(data.advancedMode){
    copyFromWindow("evidon.checkConsentTiming")();
    copyFromWindow("evidon.logConsent")();
  }
};

const setDeniedConsentValuesForAllRegions = () => {
    setDefaultConsentState({
        ad_storage: 'denied',
        analytics_storage: 'denied',
        ad_user_data: 'denied',
        ad_personalization: 'denied',
        wait_for_update: 500,
    });
};


function setDefaultConsent() {
    if (!data.regionSettings || data.regionSettings.length === 0) {
        return setDeniedConsentValuesForAllRegions();
    }

    let allRegionsRecord = false;
    data.regionSettings.forEach(settings => {
        const regions = splitInput(settings.region);
        const consentState = {
            ad_storage: settings.adStorage,
            analytics_storage: settings.analyticsStorage,
            ad_user_data: settings.adUserData,
            ad_personalization: settings.adPersonalization,
            wait_for_update: 500,
            region: regions.length ? regions : undefined,
        };
        if (!regions.length) allRegionsRecord = true;
        setDefaultConsentState(consentState);
    });

    if (!allRegionsRecord) setDeniedConsentValuesForAllRegions();
}

const updateGoogleConsent = (evidonConsentState) => {
    if(!data.advancedMode) {
           setDeniedConsentValuesForAllRegions();
    }
    updateConsentState(evidonConsentState);
    gtagSet({'ads_data_redaction': evidonConsentState.ad_Storage == 'granted' ? false : true});
    if(data.enableDebugMode) copyFromWindow("evidon.logConsentUpdate")();
};


/* --- Core Functions --- */
function defineEvidonObject() {
    const companyId = data.companyId;
    setInWindow('evidon', [], true);
    setInWindow('evidon.id', makeInteger(companyId), true);
    setInWindow('evidon.test', stagingNotice, true);
    setInWindow('evidon.updateGoogleConsent', updateGoogleConsent);
    if(activeTranslationsLangCode != "Default Language")
    {
     setInWindow('evidon.activeTranslationsLangCode', activeTranslationsLangCode);
    }

}

function injectEvidonScripts() {
    injectScript(evidonCDN);
    if(data.enableDebugMode) injectScript(debug, onSucessDebug, ()=>{log("Debug Mode fails to load");}, "Debug Mode");
}

/* --- Initialization --- */
setDefaultConsent();
defineEvidonObject();
injectEvidonScripts();
data.gtmOnSuccess();


___WEB_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "all"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "inject_script",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://dev.betrad.com/*"
              },
              {
                "type": 1,
                "string": "https://staging.betrad.com/*"
              },
              {
                "type": 1,
                "string": "https://c.evidon.com/*"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_globals",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keys",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "evidon"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "evidon.id"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "evidon.test"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "evidon.updateGoogleConsent"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "evidon.logConsentUpdate"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "evidon.logConsent"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "evidon.checkConsentTiming"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "gtag"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "evidon.googleTemplateEnabled"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "evidon.activeTranslationsLangCode"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "get_url",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urlParts",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "host",
          "value": {
            "type": 8,
            "boolean": true
          }
        },
        {
          "key": "queriesAllowed",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_consent",
        "versionId": "1"
      },
      "param": [
        {
          "key": "consentTypes",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "ad_storage"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "analytics_storage"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "ad_user_data"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "ad_personalization"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "regions"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "write_data_layer",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keyPatterns",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "ads_data_redaction"
              },
              {
                "type": 1,
                "string": "developer_id"
              },
              {
                "type": 1,
                "string": "url_passthrough"
              },
              {
                "type": 1,
                "string": "event"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios:
- name: Quick Test
  code: runCode();
setup: ''


___NOTES___

Created on 6/7/2024, 4:45:02 PM

